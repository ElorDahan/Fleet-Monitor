<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Car Inventory App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .screen { display: none; }
    .screen.active { display: block; }
    .header { background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
    .header h1 { color: #333; font-size: 24px; text-align: center; }
    .back-arrow { position: absolute; top: 20px; left: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #333; padding: 5px; }
    .btn { background: linear-gradient(45deg, #4FC3F7, #29B6F6); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; width: 100%; margin: 10px 0; box-shadow: 0 5px 15px rgba(79,195,247,0.3); transition: transform 0.2s; }
    .btn:hover { transform: translateY(-2px); }
    .btn-secondary { background: linear-gradient(45deg, #9c27b0, #7b1fa2); }
    .btn-danger { background: linear-gradient(45deg, #f44336, #d32f2f); }
    .btn-success { background: linear-gradient(45deg, #4caf50, #388e3c); }
    .btn-warning { background: linear-gradient(45deg, #ff9800, #f57c00); }
    .card { background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px; margin: 10px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    #videoElement { width: 100%; border-radius: 10px; max-height: 400px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
    .modal.active { display: flex; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; }
    .modal-content h3 { margin-bottom: 20px; color: #333; }
    .modal-content input { width: 100%; padding: 12px; font-size: 24px; text-align: center; border: 2px solid #4FC3F7; border-radius: 8px; margin: 15px 0; letter-spacing: 2px; }
    .modal-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .modal-buttons button { width: 100%; padding: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    table th, table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    table th { background: #4FC3F7; color: white; }
    .action-btn { padding: 6px 12px; margin: 0 3px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; }
    .edit-btn { background: #ff9800; color: white; }
    .delete-btn { background: #f44336; color: white; }
    .status-bar { background: rgba(255,255,255,0.95); padding: 15px; border-radius: 10px; margin: 10px 0; text-align: center; font-weight: 600; }
    .toggle-container { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: rgba(255,255,255,0.95); border-radius: 10px; margin: 10px 0; }
    .toggle { position: relative; width: 60px; height: 30px; }
    .toggle input { display: none; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 30px; transition: 0.4s; }
    .toggle input:checked + .toggle-slider { background: #4FC3F7; }
    .toggle-slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background: white; border-radius: 50%; transition: 0.4s; }
    .toggle input:checked + .toggle-slider:before { transform: translateX(30px); }
    .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .loading.active { display: flex; }
    .loading-spinner { width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.3); border-top: 6px solid #4FC3F7; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { color: white; font-size: 20px; font-weight: 600; text-align: center; padding: 0 20px; }
    canvas { display: none; }
    .report { background: white; padding: 20px; border-radius: 10px; margin: 10px 0; }
    .report-section { margin: 15px 0; }
    .report-section h4 { margin-bottom: 10px; }
    .report-item { padding: 8px; margin: 5px 0; border-radius: 5px; }
    .matched { background: #c8e6c9; }
    .missing-car { background: #ffccbc; }
    .missing-key { background: #ffe0b2; }
    .extra { background: #b39ddb; }
    .captured-image { 
      max-width: 100%; 
      max-height: 200px; 
      border-radius: 8px; 
      margin: 10px 0; 
      border: 2px solid #4FC3F7;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Home Screen -->
    <div id="homeScreen" class="screen active">
      <div class="header">
        <h1>üöó Car Inventory System</h1>
      </div>
      
      <div class="toggle-container">
        <span>Save Photos:</span>
        <label class="toggle">
          <input type="checkbox" id="savePhotosToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <button class="btn" onclick="startScanning('cars')">üì∑ Scan Physical Cars</button>
      <button class="btn" onclick="startScanning('keys')">üîë Scan Physical Keys</button>
      <button class="btn" onclick="startScanning('list')">üìù Scan Expected List</button>
      
      <button class="btn btn-secondary" onclick="showScreen('tablesScreen')">üìä View Tables</button>
      <button class="btn btn-success" onclick="generateReport()">üìà Reconciliation Report</button>
      <button class="btn btn-danger" onclick="exportToExcel()">üì• Export to Excel</button>
      <button class="btn" onclick="clearAllData()" style="background: linear-gradient(45deg, #666, #444);">üóëÔ∏è Clear All Data</button>
    </div>

    <!-- Scanning Screen -->
    <div id="scanScreen" class="screen">
      <div class="header">
        <button class="back-arrow" onclick="stopScanning()">‚Üê</button>
        <h1 id="scanTitle">Scanning...</h1>
      </div>
      
      <div class="card">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <button class="btn" onclick="capturePhoto()">üì∏ Capture</button>
      </div>
      
      <div id="listPagesStatus" class="status-bar" style="display:none;">
        Pages captured: <span id="pageCount">0</span>
      </div>
      <button id="processListBtn" class="btn btn-success" style="display:none;" onclick="processAllPages()">‚úÖ Process All Pages</button>
    </div>

    <!-- Tables Screen -->
    <div id="tablesScreen" class="screen">
      <div class="header">
        <button class="back-arrow" onclick="showScreen('homeScreen')">‚Üê</button>
        <h1>üìä Data Tables</h1>
      </div>
      
      <div class="card">
        <h3>Physical Cars (<span id="carsCount">0</span>)</h3>
        <input type="text" id="searchCars" placeholder="Search cars..." style="width:100%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ddd;">
        <div style="overflow-x:auto;">
          <table id="carsTable">
            <thead><tr><th>Plate Number</th><th>Date/Time</th><th>Photo</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Physical Keys (<span id="keysCount">0</span>)</h3>
        <input type="text" id="searchKeys" placeholder="Search keys..." style="width:100%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ddd;">
        <div style="overflow-x:auto;">
          <table id="keysTable">
            <thead><tr><th>Key Number</th><th>Date/Time</th><th>Photo</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Expected Inventory (<span id="expectedCount">0</span>)</h3>
        <input type="text" id="searchExpected" placeholder="Search expected..." style="width:100%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ddd;">
        <div style="overflow-x:auto;">
          <table id="expectedTable">
            <thead><tr><th>Plate Number</th><th>Date/Time</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <button class="btn btn-secondary" onclick="showScreen('homeScreen')">‚óÄ Back to Home</button>
    </div>

    <!-- Report Screen -->
    <div id="reportScreen" class="screen">
      <div class="header">
        <button class="back-arrow" onclick="showScreen('homeScreen')">‚Üê</button>
        <h1>üìà Reconciliation Report</h1>
      </div>
      
      <div id="reportContent" class="card"></div>
      
      <button class="btn btn-secondary" onclick="showScreen('homeScreen')">‚óÄ Back to Home</button>
    </div>

  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">üîç Reading plate number...<br>Please wait...</div>
  </div>

  <!-- Verification Modal -->
  <div id="verificationModal" class="modal">
    <div class="modal-content">
      <h3>Verify Plate Number</h3>
      <img id="capturedImage" class="captured-image" style="display:none;">
      <p>Detected: <strong id="extractedText"></strong></p>
      <p style="font-size: 14px; color: #666; margin: 10px 0;">Type the plate number while looking at the photo above:</p>
      <input type="text" id="plateInput" placeholder="123-45-678" maxlength="10" inputmode="numeric">
      <div class="modal-buttons">
        <button class="btn btn-success" onclick="confirmPlate()">‚úì OK</button>
        <button class="btn btn-secondary" onclick="fixPlate()">‚úèÔ∏è Fix Manually</button>
        <button class="btn btn-warning" onclick="retakePhoto()">üì∏ Retake Photo</button>
      </div>
    </div>
  </div>

<script>
let db = {
  cars: [],
  keys: [],
  expected: [],
  listPages: [],
  apiUsage: {
    plateRecognizer: 0,  // License plate API calls
    googleVision: 0      // Handwriting API calls
  }
};

// Load data from localStorage on startup
function loadDataFromStorage() {
  try {
    const savedData = localStorage.getItem('carInventoryData');
    if (savedData) {
      const parsed = JSON.parse(savedData);
      db = { ...db, ...parsed };
      console.log('Data loaded from storage:', db);
      updateTables(); // Update UI with loaded data
    }
  } catch (error) {
    console.error('Error loading data from storage:', error);
  }
}

// Save data to localStorage
function saveDataToStorage() {
  try {
    localStorage.setItem('carInventoryData', JSON.stringify(db));
    console.log('Data saved to storage');
  } catch (error) {
    console.error('Error saving data to storage:', error);
  }
}

// Auto-save data whenever it changes
function addToDatabase(type, item) {
  db[type].push(item);
  saveDataToStorage();
  updateTables();
}

// Load data when page starts
document.addEventListener('DOMContentLoaded', function() {
  loadDataFromStorage();
});

let currentScanType = '';
let stream = null;
let savePhotos = false;

document.getElementById('savePhotosToggle').addEventListener('change', (e) => {
  savePhotos = e.target.checked;
});

function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

function showLoading(show) {
  const loading = document.getElementById('loadingScreen');
  if (show) {
    loading.classList.add('active');
  } else {
    loading.classList.remove('active');
  }
}

async function startScanning(type) {
  currentScanType = type;
  showScreen('scanScreen');
  
  const titles = {
    cars: 'üì∑ Scanning Physical Cars',
    keys: 'üîë Scanning Physical Keys',
    list: 'üìù Scanning Expected List'
  };
  document.getElementById('scanTitle').textContent = titles[type];
  
  if (type === 'list') {
    document.getElementById('listPagesStatus').style.display = 'block';
    document.getElementById('processListBtn').style.display = 'block';
    updatePageCount();
  } else {
    document.getElementById('listPagesStatus').style.display = 'none';
    document.getElementById('processListBtn').style.display = 'none';
  }
  
  try {
    // Different camera settings for cars vs keys
    let constraints = {
      video: {
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    };
    
    // For cars, request less zoom
    if (type === 'cars') {
      constraints.video.zoom = 1;
    }
    
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    const videoTrack = stream.getVideoTracks()[0];
    
    // Try to set zoom to minimum for cars
    if (type === 'cars' && videoTrack.getCapabilities) {
      const capabilities = videoTrack.getCapabilities();
      if (capabilities.zoom) {
        await videoTrack.applyConstraints({
          advanced: [{ zoom: capabilities.zoom.min }]
        });
      }
    }
    
    document.getElementById('videoElement').srcObject = stream;
  } catch (err) {
    alert('Camera access denied. Please allow camera access.');
    showScreen('homeScreen');
  }
}

function stopScanning() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
  showScreen('homeScreen');
}

async function capturePhoto() {
  console.log("=== CAPTURE PHOTO CALLED ===", new Date().toLocaleTimeString());
  
  const video = document.getElementById('videoElement');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  
  // Draw the image
  ctx.drawImage(video, 0, 0);
  
  const originalImage = canvas.toDataURL('image/jpeg', 0.95);
  let processedImage;
  
  // Only process for keys - cars use original image
  if (currentScanType === 'keys') {
    // Pre-process image for keys (high contrast, grayscale)
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    
    // Increase contrast for keys
    for (let i = 0; i < data.length; i += 4) {
      // Convert to grayscale
      const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
      // Increase contrast
      const contrast = ((gray / 255 - 0.5) * 1.5 + 0.5) * 255;
      data[i] = data[i + 1] = data[i + 2] = contrast;
    }
    ctx.putImageData(imageData, 0, 0);
    processedImage = canvas.toDataURL('image/jpeg', 0.95);
  } else {
    // For cars and lists, use original image
    processedImage = originalImage;
  }
  
  if (currentScanType === 'list') {
    db.listPages.push(processedImage);
    updatePageCount();
    return;
  }
  
  // Show loading screen
  showLoading(true);
  
  let text = ''; // Declare text variable here
  
  console.log("Current scan type:", currentScanType);
  
  try {
    let ocrConfig;
    
    // Different OCR settings for keys vs cars
    if (currentScanType === 'keys') {
      console.log("ENTERING KEYS SECTION - Should use Google Vision");
      ocrConfig = {
        logger: m => console.log(m),
        tessedit_char_whitelist: '0123456789',
        tessedit_pageseg_mode: Tesseract.PSM.AUTO
      };
    } else {
      // This section is for cars but won't be used since API is called first
      ocrConfig = {
        logger: m => console.log(m),
        tessedit_char_whitelist: '0123456789',
        tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
        preserve_interword_spaces: '0',
        tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY
      };
    }
    
    if (currentScanType === 'cars') {
      // For license plates, use PlateRecognizer API
      document.querySelector('.loading-text').textContent = 'üîç Reading license plate...\nUsing AI recognition...';
      
      try {
        // Convert image to base64 (use original image, not processed)
        const base64Image = originalImage.split(',')[1];
        
        // Call PlateRecognizer API
        const response = await fetch('https://api.platerecognizer.com/v1/plate-reader/', {
          method: 'POST',
          headers: {
            'Authorization': 'Token a5c0d06220cdb26cf93a3568bf98c723236828d3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            upload: base64Image,
            regions: ['il'] // Israel
          })
        });
        
        const data = await response.json();
        console.log('PlateRecognizer response:', data);
        
        // Increment API usage counter
        db.apiUsage.plateRecognizer++;
        console.log('PlateRecognizer API calls used this session:', db.apiUsage.plateRecognizer);
        
        showLoading(false);
        
        let detectedPlate = '';
        if (data.results && data.results.length > 0) {
          // Get the plate with highest confidence
          const bestResult = data.results.reduce((prev, current) => 
            (current.score > prev.score) ? current : prev
          );
          
          detectedPlate = bestResult.plate.replace(/\D/g, ''); // Extract only digits
          console.log('Detected plate:', detectedPlate, 'confidence:', bestResult.score);
        }
        
        // Find valid 8-digit sequence
        let finalMatch = '';
        if (detectedPlate.length >= 8) {
          for (let i = 0; i <= detectedPlate.length - 8; i++) {
            let candidate = detectedPlate.substring(i, i + 8);
            if (candidate[0] !== '0') {
              finalMatch = candidate;
              break;
            }
          }
          if (!finalMatch) {
            finalMatch = detectedPlate.substring(0, 8);
          }
        }
        
        console.log('Final match:', finalMatch);
        
        // Show the original captured image (not processed)
        document.getElementById('capturedImage').src = originalImage;
        document.getElementById('capturedImage').style.display = 'block';
        
        showVerificationModal(finalMatch, originalImage);
        
      } catch (error) {
        showLoading(false);
        console.error('API Error:', error);
        alert('Failed to connect to recognition service. Please check your internet connection or API token.');
        
        // Fallback to manual entry with original image
        document.getElementById('capturedImage').src = originalImage;
        document.getElementById('capturedImage').style.display = 'block';
        showVerificationModal('', originalImage);
      }
      return;
    }
    
    const result = await Tesseract.recognize(processedImage, 'eng', ocrConfig);
    
    showLoading(false);
    
    let text = result.data.text;
    console.log('Raw OCR result:', text);
    console.log('Confidence:', result.data.confidence);
    
    // Extract only digits
    let allDigits = text.replace(/\D/g, '');
    console.log('All digits found:', allDigits);
    
    // Find valid 8-digit plate numbers (not starting with 0)
    let bestMatch = '';
    
    if (currentScanType === 'cars') {
      // For license plates, be more flexible
      // Look for ANY sequence of 8 digits (since plates can have varied formats)
      if (allDigits.length >= 8) {
        // Try to find a sequence that doesn't start with 0
        for (let i = 0; i <= allDigits.length - 8; i++) {
          let candidate = allDigits.substring(i, i + 8);
          if (candidate[0] !== '0') {
            bestMatch = candidate;
            break;
          }
        }
        // If all start with 0, just take first 8
        if (!bestMatch) {
          bestMatch = allDigits.substring(0, 8);
        }
      }
    } else {
      // For keys, use strict matching
      for (let i = 0; i <= allDigits.length - 8; i++) {
        let candidate = allDigits.substring(i, i + 8);
        if (candidate[0] !== '0') {
          bestMatch = candidate;
          console.log('Valid match found:', bestMatch);
          break;
        }
      }
      
      if (!bestMatch && allDigits.length >= 8) {
        for (let i = 0; i <= allDigits.length - 8; i++) {
          if (allDigits[i] !== '0') {
            bestMatch = allDigits.substring(i, i + 8);
            break;
          }
        }
      }
    }
    
    console.log('Final match:', bestMatch);
    
    // Show the captured image in modal
    document.getElementById('capturedImage').src = processedImage;
    document.getElementById('capturedImage').style.display = 'block';
    
    showVerificationModal(bestMatch, processedImage);
  } catch (err) {
    showLoading(false);
    alert('OCR failed. Please try again with better lighting or a clearer photo.');
    console.error('OCR Error:', err);
  }
}

function formatPlateNumber(text) {
  // Remove all non-digits
  text = text.replace(/\D/g, '');
  
  // If we have at least 8 digits, format it
  if (text.length >= 8) {
    return text.slice(0,3) + '-' + text.slice(3,5) + '-' + text.slice(5,8);
  }
  
  return text;
}

function showVerificationModal(extracted, photo) {
  const formatted = formatPlateNumber(extracted);
  
  // Always show the detected line
  document.getElementById('extractedText').parentElement.style.display = 'block';
  document.getElementById('extractedText').textContent = formatted || 'None detected';
  
  document.getElementById('plateInput').value = formatted;
  document.getElementById('verificationModal').classList.add('active');
  document.getElementById('verificationModal').dataset.photo = photo;
  
  // Focus on input for easy editing
  setTimeout(() => {
    const input = document.getElementById('plateInput');
    input.focus();
    input.select();
  }, 100);
}

// Add auto-dash formatting as user types
document.getElementById('plateInput').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
  
  // Limit to exactly 8 digits
  if (value.length > 8) {
    value = value.substring(0, 8);
  }
  
  let formatted = '';
  
  // Add dashes automatically as user types
  if (value.length > 0) {
    formatted = value.substring(0, 3);
  }
  if (value.length >= 4) {
    formatted += '-' + value.substring(3, 5);
  }
  if (value.length >= 6) {
    formatted += '-' + value.substring(5, 8);
  }
  
  // Update input value with cursor position preservation
  const cursorPos = e.target.selectionStart;
  const oldValue = e.target.value;
  e.target.value = formatted;
  
  // Adjust cursor position if dashes were added
  if (formatted.length > oldValue.length && (formatted[cursorPos] === '-')) {
    e.target.setSelectionRange(cursorPos + 1, cursorPos + 1);
  }
});

function confirmPlate() {
  let plate = document.getElementById('plateInput').value.trim();
  
  // Auto-format: remove all non-digits and format
  plate = formatPlateNumber(plate);
  
  if (!validatePlateFormat(plate)) {
    alert('Invalid format! Need 8 digits. Example: 12345678 becomes 123-45-678');
    return;
  }
  
  // Additional validation: plate cannot start with 0
  if (plate[0] === '0') {
    alert('Invalid plate! Plate number cannot start with 0.');
    return;
  }
  
  savePlate(plate);
}

function fixPlate() {
  const input = document.getElementById('plateInput');
  input.focus();
  input.select();
}

function retakePhoto() {
  // Close modal and stay on scan screen
  document.getElementById('verificationModal').classList.remove('active');
  // User can now take another photo
}

function cancelScan() {
  // Close modal and go back to home screen
  document.getElementById('verificationModal').classList.remove('active');
  stopScanning();
}

function validatePlateFormat(plate) {
  return /^\d{3}-\d{2}-\d{3}$/.test(plate);
}

function savePlate(plate) {
  const table = currentScanType === 'cars' ? 'cars' : 'keys';
  
  if (db[table].some(item => item.plate === plate)) {
    alert('‚ö†Ô∏è Already scanned: ' + plate);
    document.getElementById('verificationModal').classList.remove('active');
    return;
  }
  
  const photo = document.getElementById('verificationModal').dataset.photo;
  const item = {
    plate: plate,
    timestamp: new Date().toLocaleString(),
    photo: savePhotos ? photo : null
  };
  
  // Use new database system that auto-saves
  addToDatabase(table, item);
  
  document.getElementById('verificationModal').classList.remove('active');
  
  // Show success feedback
  alert('‚úÖ Saved: ' + plate);
}

function updatePageCount() {
  document.getElementById('pageCount').textContent = db.listPages.length;
}

async function processAllPages() {
  if (db.listPages.length === 0) {
    alert('No pages captured!');
    return;
  }
  
  showLoading(true);
  document.querySelector('.loading-text').textContent = 'üîç Processing all pages...\nThis may take a minute...';
  
  const allPlates = [];
  
  for (let i = 0; i < db.listPages.length; i++) {
    try {
      const result = await Tesseract.recognize(db.listPages[i], 'eng', {
        tessedit_char_whitelist: '0123456789'
      });
      const text = result.data.text;
      const lines = text.split('\n');
      
      lines.forEach(line => {
        let cleaned = line.replace(/\D/g, '');
        if (cleaned.length >= 8) {
          let formatted = formatPlateNumber(cleaned);
          if (validatePlateFormat(formatted) && !allPlates.includes(formatted)) {
            allPlates.push(formatted);
          }
        }
      });
    } catch (err) {
      console.error('Error processing page', i, err);
    }
  }
  
  allPlates.forEach(plate => {
    if (!db.expected.some(item => item.plate === plate)) {
      const item = {
        plate: plate,
        timestamp: new Date().toLocaleString(),
        photo: null
      };
      addToDatabase('expected', item);
    }
  });
  
  showLoading(false);
  const pagesProcessed = db.listPages.length;
  db.listPages = [];
  updatePageCount();
  alert(`‚úÖ Processed ${allPlates.length} plates from ${pagesProcessed} pages`);
  stopScanning();
}

function updateTables() {
  renderTable('carsTable', db.cars, 'carsCount');
  renderTable('keysTable', db.keys, 'keysCount');
  renderTable('expectedTable', db.expected, 'expectedCount');
}

function renderTable(tableId, data, countId) {
  const tbody = document.getElementById(tableId).querySelector('tbody');
  tbody.innerHTML = '';
  
  data.forEach((item, index) => {
    const row = tbody.insertRow();
    row.insertCell(0).textContent = item.plate;
    row.insertCell(1).textContent = item.timestamp;
    
    // Photo column
    const photoCell = row.insertCell(2);
    if (item.photo) {
      const img = document.createElement('img');
      img.src = item.photo;
      img.style.width = '50px';
      img.style.height = '30px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '4px';
      img.style.cursor = 'pointer';
      img.onclick = () => showFullImage(item.photo);
      photoCell.appendChild(img);
    } else {
      photoCell.textContent = 'No photo';
    }
    
    // Actions column
    const actionsCell = row.insertCell(3);
    actionsCell.innerHTML = `
      <button class="action-btn edit-btn" onclick="editEntry('${tableId}', ${index})">Edit</button>
      <button class="action-btn delete-btn" onclick="deleteEntry('${tableId}', ${index})">Delete</button>
    `;
  });
  
  document.getElementById(countId).textContent = data.length;
}

function showFullImage(imageSrc) {
  // Create modal to show full-size image
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.9); z-index: 3000; display: flex; 
    justify-content: center; align-items: center;
  `;
  
  // Create close button
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '√ó';
  closeBtn.style.cssText = `
    position: absolute; top: 20px; right: 20px; 
    background: rgba(255,255,255,0.9); border: none; 
    font-size: 30px; width: 40px; height: 40px; 
    border-radius: 50%; cursor: pointer; z-index: 3001;
    color: #333; font-weight: bold;
  `;
  
  const img = document.createElement('img');
  img.src = imageSrc;
  img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
  
  modal.appendChild(closeBtn);
  modal.appendChild(img);
  document.body.appendChild(modal);
  
  // Close on click
  const closeModal = () => document.body.removeChild(modal);
  closeBtn.onclick = closeModal;
  modal.onclick = (e) => {
    if (e.target === modal) closeModal();
  };
}

function editEntry(tableId, index) {
  const dataKey = tableId.replace('Table', '');
  const dataArray = db[dataKey];
  const newPlate = prompt('Enter new plate number (just digits):', dataArray[index].plate);
  
  if (newPlate) {
    const formatted = formatPlateNumber(newPlate);
    if (validatePlateFormat(formatted)) {
      dataArray[index].plate = formatted;
      saveDataToStorage(); // Save after edit
      updateTables();
    } else {
      alert('Invalid format! Need 8 digits.');
    }
  }
}

function deleteEntry(tableId, index) {
  if (confirm('Delete this entry?')) {
    const dataKey = tableId.replace('Table', '');
    db[dataKey].splice(index, 1);
    saveDataToStorage(); // Save after delete
    updateTables();
  }
}

function generateReport() {
  const report = {
    matched: [],
    missingCar: [],
    missingKey: [],
    extra: []
  };
  
  const carPlates = new Set(db.cars.map(c => c.plate));
  const keyPlates = new Set(db.keys.map(k => k.plate));
  const expectedPlates = new Set(db.expected.map(e => e.plate));
  
  expectedPlates.forEach(plate => {
    const hasCar = carPlates.has(plate);
    const hasKey = keyPlates.has(plate);
    
    if (hasCar && hasKey) {
      report.matched.push(plate);
    } else if (!hasCar && hasKey) {
      report.missingCar.push(plate);
    } else if (hasCar && !hasKey) {
      report.missingKey.push(plate);
    } else {
      report.missingCar.push(plate);
      report.missingKey.push(plate);
    }
  });
  
  carPlates.forEach(plate => {
    if (!expectedPlates.has(plate)) {
      report.extra.push({ type: 'car', plate });
    }
  });
  
  keyPlates.forEach(plate => {
    if (!expectedPlates.has(plate)) {
      report.extra.push({ type: 'key', plate });
    }
  });
  
  displayReport(report);
}

function displayReport(report) {
  const content = document.getElementById('reportContent');
  content.innerHTML = `
    <h2>üìä Summary</h2>
    <p><strong>Total Expected:</strong> ${db.expected.length}</p>
    <p><strong>Cars Found:</strong> ${db.cars.length}</p>
    <p><strong>Keys Found:</strong> ${db.keys.length}</p>
    <p><strong>Perfect Matches:</strong> ${report.matched.length}</p>
    <p><strong>Issues Found:</strong> ${report.missingCar.length + report.missingKey.length + report.extra.length}</p>
    <hr>
    
    <div class="report-section">
      <h4>‚úÖ MATCHED (${report.matched.length})</h4>
      ${report.matched.map(p => `<div class="report-item matched">${p}: Car ‚úì Key ‚úì Expected ‚úì</div>`).join('')}
    </div>
    
    <div class="report-section">
      <h4>‚ö†Ô∏è MISSING CARS (${report.missingCar.length})</h4>
      ${report.missingCar.map(p => `<div class="report-item missing-car">${p}: Car ‚úó Key ? Expected ‚úì</div>`).join('')}
    </div>
    
    <div class="report-section">
      <h4>‚ö†Ô∏è MISSING KEYS (${report.missingKey.length})</h4>
      ${report.missingKey.map(p => `<div class="report-item missing-key">${p}: Car ? Key ‚úó Expected ‚úì</div>`).join('')}
    </div>
    
    <div class="report-section">
      <h4>üö® EXTRA ITEMS (${report.extra.length})</h4>
      ${report.extra.map(item => `<div class="report-item extra">${item.plate}: ${item.type === 'car' ? 'Car' : 'Key'} ‚úì Expected ‚úó</div>`).join('')}
    </div>
  `;
  
  showScreen('reportScreen');
}

function exportToExcel() {
  const wb = XLSX.utils.book_new();
  
  const carsWS = XLSX.utils.json_to_sheet(db.cars.map(c => ({ 'Plate Number': c.plate, 'Date/Time': c.timestamp })));
  XLSX.utils.book_append_sheet(wb, carsWS, 'Physical Cars');
  
  const keysWS = XLSX.utils.json_to_sheet(db.keys.map(k => ({ 'Key Number': k.plate, 'Date/Time': k.timestamp })));
  XLSX.utils.book_append_sheet(wb, keysWS, 'Physical Keys');
  
  const expectedWS = XLSX.utils.json_to_sheet(db.expected.map(e => ({ 'Plate Number': e.plate, 'Date/Time': e.timestamp })));
  XLSX.utils.book_append_sheet(wb, expectedWS, 'Expected Inventory');
  
  XLSX.writeFile(wb, `CarInventory_${new Date().toISOString().split('T')[0]}.xlsx`);
}

function clearAllData() {
  if (confirm('‚ö†Ô∏è This will delete ALL scanned data. Are you sure?')) {
    if (confirm('üö® This cannot be undone! Delete everything?')) {
      // Reset database
      db = {
        cars: [],
        keys: [],
        expected: [],
        listPages: [],
        apiUsage: {
          plateRecognizer: 0,
          googleVision: 0
        }
      };
      
      // Clear from localStorage
      localStorage.removeItem('carInventoryData');
      
      // Update UI
      updateTables();
      
      alert('‚úÖ All data cleared');
    }
  }
}

document.getElementById('searchCars')?.addEventListener('input', (e) => filterTable('carsTable', e.target.value));
document.getElementById('searchKeys')?.addEventListener('input', (e) => filterTable('keysTable', e.target.value));
document.getElementById('searchExpected')?.addEventListener('input', (e) => filterTable('expectedTable', e.target.value));

function filterTable(tableId, query) {
  const table = document.getElementById(tableId);
  const rows = table.querySelectorAll('tbody tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
  });
}
</script>
</body>
</html>
